# 博客管理系统 - 项目层次结构图

## 系统整体层次结构

```mermaid
graph TB
    subgraph "表现层 (Presentation Layer)"
        BC[BlogController]
        LC[LLMController]
        CC[ConfigController]
        IC[ImageController]
    end
  
    subgraph "业务服务层 (Service Layer)"
        BFS[BlogFileService]
        CS[ConfigService]
        subgraph "LLM服务模块"
            LLM[LLM接口]
            XMF[XModelFactory]
            BMF[BigModelFactory]
            FI[FactoryInterface]
            SC[StreamCallback]
            PM[Prompt]
        end
    end
  
    subgraph "数据访问层 (Repository Layer)"
        BFS
        CS
    end
  
    subgraph "实体层 (Model Layer)"
        B[Blog]
        M[Message]
        C[Config]
        PM2[POSTMessage]
    end
  
    subgraph "外部系统"
        FS[文件系统]
        API[第三方LLM API]
    end
  
    %% 控制器依赖关系
    BC --> BFS
    BC --> B
    BC --> M
  
    LC --> LLM
    LC --> XMF
    LC --> BMF
    LC --> C
    LC --> PM
    LC --> SC
  
    CC --> CS
    CC --> C
  
    IC --> C
  
    %% 服务层依赖关系
    BFS --> B
    BFS --> C
    CS --> C
  
    XMF --> LLM
    XMF --> C
    BMF --> LLM
    BMF --> C
    XMF -.-> FI
    BMF -.-> FI
  
    LLM --> PM2
    LLM --> SC
  
    %% 数据访问
    BFS --> FS
    CS --> FS
    LLM --> API
  
    style BC fill:#e1f5fe
    style LC fill:#e1f5fe
    style CC fill:#e1f5fe
    style IC fill:#e1f5fe
  
    style BFS fill:#e8f5e8
    style CS fill:#e8f5e8
    style LLM fill:#e8f5e8
    style XMF fill:#e8f5e8
    style BMF fill:#e8f5e8
  
    style B fill:#fff3e0
    style M fill:#fff3e0
    style C fill:#fff3e0
    style PM2 fill:#fff3e0
```

## 详细层次依赖关系图

```mermaid
classDiagram
    %% 控制器层
    class BlogController {
        -BlogFileService blogFileService
        -List~Blog~ blogList
        +searchBydata(Blog) Blog
        +getAllBlogs() Message
        +getBlogByTitle(String) Message
        +saveBlog(Blog) Message
        +deleteBlog(String) Message
    }
  
    class LLMController {
        -LLM llm
        -Config config
        -ExecutorService executor
        +getLlm(String) void
        +generateResponse(String) SseEmitter
        +streamChat(String) SseEmitter
    }
  
    class ConfigController {
        -ConfigService config
        +getConfig() Config
        +setConfig(Config) boolean
    }
  
    class ImageController {
        -String imageStoragePath
        +getImage(String) ResponseEntity
        +uploadImage(MultipartFile) Map
    }
  
    %% 服务层/数据访问层
    class BlogFileService {
        -Path storageLocation
        -Config config
        +init() void
        +loadAllBlogs() List~Blog~
        +saveBlog(Blog) void
        +deleteBlog(String) boolean
        +getBlogByTitle(String) Blog
    }
  
    class ConfigService {
        -Path configPath
        -Config config
        +loadConfig() void
        +getConfig() Config
        +updateConfig(Config) boolean
        +saveConfig() boolean
    }
  
    %% LLM服务层
    class LLM {
        <<abstract>>
        -String APIKey
        -String APIUrl
        -String model
        #ArrayList~POSTMessage~ messagesArray
        +streamResponse(String, StreamCallback) void
        +generateResponse(String) String
    }
  
    class XModelFactory {
        -Config config
        +createLLM() LLM
    }
  
    class BigModelFactory {
        -Config config
        +createLLM() LLM
    }
  
    class FactoryInterface {
        <<interface>>
        +createLLM() LLM
    }
  
    class StreamCallback {
        +onToken(String) void
        +onComplete() void
        +onError(Exception) void
    }
  
    %% 实体层
    class Blog {
        -Path filepath
        -String filename
        -String title
        -LocalDateTime dateTime
        -String categories
        -String[] tags
        -String saying
        -String content
        +clone() Blog
        +equals(Object) boolean
        +compareTo(Blog) int
    }
  
    class Message {
        -int status
        -Object data
        -String error
        +getStatus() int
        +getData() Object
        +getError() String
    }
  
    class Config {
        -String blogStoragePath
        -String imageStoragePath
        -String xmodelAPIKey
        -String bigmodelAPIKey
        +getBlogStoragePath() String
        +getImageStoragePath() String
    }
  
    class POSTMessage {
        -String role
        -String content
        +getRole() String
        +getContent() String
    }
  
    %% 依赖关系
    BlogController --> BlogFileService : uses
    BlogController --> Blog : uses
    BlogController --> Message : creates
  
    LLMController --> LLM : uses
    LLMController --> XModelFactory : creates
    LLMController --> BigModelFactory : creates
    LLMController --> Config : uses
    LLMController --> StreamCallback : uses
  
    ConfigController --> ConfigService : uses
    ConfigController --> Config : uses
  
    ImageController --> Config : uses
  
    BlogFileService --> Blog : manages
    BlogFileService --> Config : uses
  
    ConfigService --> Config : manages
  
    XModelFactory ..|> FactoryInterface : implements
    BigModelFactory ..|> FactoryInterface : implements
    XModelFactory --> LLM : creates
    BigModelFactory --> LLM : creates
    XModelFactory --> Config : uses
    BigModelFactory --> Config : uses
  
    LLM --> POSTMessage : uses
    LLM --> StreamCallback : uses
```

## 各层职责说明

### 控制器层 (Controller Layer)

- **BlogController**: 处理博客相关的HTTP请求，包括博客的增删改查
- **LLMController**: 处理大语言模型相关请求，包括流式对话和响应生成
- **ConfigController**: 处理系统配置的获取和更新
- **ImageController**: 处理图片上传和访问请求

### 服务层 (Service Layer)

- **BlogFileService**: 博客文件的业务逻辑处理，包括文件读写、博客解析等
- **ConfigService**: 系统配置的业务逻辑，配置文件的加载和保存
- **LLM相关服务**: 大语言模型的抽象和具体实现，使用工厂模式创建不同的LLM实例

### 数据访问层 (Repository Layer)

- 在本项目中，BlogFileService和ConfigService同时承担了数据访问的职责
- 直接与文件系统交互，进行数据持久化

### 实体层 (Model Layer)

- **Blog**: 博客实体，包含博客的所有属性和元数据
- **Message**: 统一的响应消息格式
- **Config**: 系统配置实体
- **POSTMessage**: LLM交互的消息实体

## 设计模式应用

1. **工厂模式**: XModelFactory和BigModelFactory实现FactoryInterface，用于创建不同类型的LLM实例
2. **依赖注入**: 使用Spring的@Autowired注解实现依赖注入
3. **模板方法模式**: LLM抽象类定义了通用的方法结构
4. **回调模式**: StreamCallback用于处理流式响应

## 分层详细结构图

### 1. 控制器层 (Controller Layer) 结构图

```mermaid
graph TB
    subgraph "控制器层 (Controller Layer)"
        BC[BlogController<br/>博客控制器]
        LC[LLMController<br/>LLM控制器]
        CC[ConfigController<br/>配置控制器]
        IC[ImageController<br/>图片控制器]
    end
    
    subgraph "HTTP请求类型"
        GET[GET请求]
        POST[POST请求]
        PUT[PUT请求]
        DELETE[DELETE请求]
    end
    
    subgraph "请求映射"
        B_GET["/api/blogs GET<br/>获取所有博客"]
        B_POST["/api/blogs POST<br/>保存博客"]
        B_DELETE["/api/blogs/{title} DELETE<br/>删除博客"]
        B_SEARCH["/api/blogs/search POST<br/>搜索博客"]
        
        L_POST["/api/llm/chat POST<br/>LLM对话"]
        L_STREAM["/api/llm/stream POST<br/>流式对话"]
        
        C_GET["/api/config GET<br/>获取配置"]
        C_PUT["/api/config PUT<br/>更新配置"]
        
        I_GET["/api/images/{filename} GET<br/>获取图片"]
        I_POST["/api/images/upload POST<br/>上传图片"]
    end
    
    BC --> B_GET
    BC --> B_POST
    BC --> B_DELETE
    BC --> B_SEARCH
    
    LC --> L_POST
    LC --> L_STREAM
    
    CC --> C_GET
    CC --> C_PUT
    
    IC --> I_GET
    IC --> I_POST
    
    GET --> B_GET
    GET --> C_GET
    GET --> I_GET
    
    POST --> B_POST
    POST --> B_SEARCH
    POST --> L_POST
    POST --> L_STREAM
    POST --> I_POST
    
    PUT --> C_PUT
    DELETE --> B_DELETE
    
    style BC fill:#e3f2fd
    style LC fill:#e3f2fd
    style CC fill:#e3f2fd
    style IC fill:#e3f2fd
```

### 2. 服务层 (Service Layer) 结构图

```mermaid
graph TB
    subgraph "核心服务层"
        BFS[BlogFileService<br/>博客文件服务]
        CS[ConfigService<br/>配置服务]
    end
    
    subgraph "LLM服务子系统"
        LLM[LLM<br/>抽象基类]
        XMF[XModelFactory<br/>讯飞工厂]
        BMF[BigModelFactory<br/>智谱工厂]
        FI[FactoryInterface<br/>工厂接口]
        SC[StreamCallback<br/>流回调]
        PM[Prompt<br/>提示词]
    end
    
    subgraph "服务方法"
        BFS_METHODS["• init()<br/>• loadAllBlogs()<br/>• saveBlog()<br/>• deleteBlog()<br/>• getBlogByTitle()"]
        CS_METHODS["• loadConfig()<br/>• getConfig()<br/>• updateConfig()<br/>• saveConfig()"]
        LLM_METHODS["• streamResponse()<br/>• generateResponse()<br/>• setAPIKey()<br/>• setModel()"]
    end
    
    subgraph "工厂方法"
        FACTORY_METHODS["• createLLM()<br/>• configureAPI()<br/>• validateConfig()"]
    end
    
    BFS --> BFS_METHODS
    CS --> CS_METHODS
    LLM --> LLM_METHODS
    
    XMF --> FACTORY_METHODS
    BMF --> FACTORY_METHODS
    XMF -.-> FI
    BMF -.-> FI
    
    XMF --> LLM
    BMF --> LLM
    
    LLM --> SC
    LLM --> PM
    
    style BFS fill:#e8f5e8
    style CS fill:#e8f5e8
    style LLM fill:#fff3e0
    style XMF fill:#fff3e0
    style BMF fill:#fff3e0
    style FI fill:#fce4ec
    style SC fill:#f3e5f5
    style PM fill:#f3e5f5
```

### 3. 数据访问层 (Repository Layer) 结构图

```mermaid
graph TB
    subgraph "数据访问层 (Repository Layer)"
        BFS_REPO[BlogFileService<br/>博客数据访问]
        CS_REPO[ConfigService<br/>配置数据访问]
    end
    
    subgraph "数据存储"
        MD_FILES[Markdown文件<br/>(.md)]
        JSON_CONFIG[配置文件<br/>(config.json)]
        IMAGE_FILES[图片文件<br/>(.jpg/.png)]
    end
    
    subgraph "文件操作"
        READ[文件读取]
        WRITE[文件写入]
        DELETE[文件删除]
        CREATE[文件创建]
        LIST[文件列表]
    end
    
    subgraph "数据操作方法"
        BLOG_OPS["• 读取博客目录<br/>• 解析Markdown<br/>• 提取元数据<br/>• 保存博客文件<br/>• 删除博客文件"]
        CONFIG_OPS["• 读取JSON配置<br/>• 解析配置对象<br/>• 保存配置文件<br/>• 验证配置格式"]
    end
    
    BFS_REPO --> BLOG_OPS
    CS_REPO --> CONFIG_OPS
    
    BFS_REPO --> MD_FILES
    BFS_REPO --> IMAGE_FILES
    CS_REPO --> JSON_CONFIG
    
    BLOG_OPS --> READ
    BLOG_OPS --> WRITE
    BLOG_OPS --> DELETE
    BLOG_OPS --> LIST
    
    CONFIG_OPS --> READ
    CONFIG_OPS --> WRITE
    CONFIG_OPS --> CREATE
    
    style BFS_REPO fill:#e1f5fe
    style CS_REPO fill:#e1f5fe
    style MD_FILES fill:#fff3e0
    style JSON_CONFIG fill:#fff3e0
    style IMAGE_FILES fill:#fff3e0
```

### 4. 实体层 (Model Layer) 结构图

```mermaid
graph TB
    subgraph "核心实体类"
        BLOG[Blog<br/>博客实体]
        CONFIG[Config<br/>配置实体]
        MESSAGE[Message<br/>响应消息]
        POST_MSG[POSTMessage<br/>POST消息]
    end
    
    subgraph "Blog属性"
        BLOG_PROPS["• Path filepath<br/>• String filename<br/>• String title<br/>• LocalDateTime dateTime<br/>• String categories<br/>• String[] tags<br/>• String saying<br/>• String content"]
    end
    
    subgraph "Config属性"
        CONFIG_PROPS["• String blogStoragePath<br/>• String imageStoragePath<br/>• String xmodelAPIKey<br/>• String bigmodelAPIKey<br/>• String xmodelAPIUrl<br/>• String bigmodelAPIUrl"]
    end
    
    subgraph "Message属性"
        MESSAGE_PROPS["• int status<br/>• Object data<br/>• String error"]
    end
    
    subgraph "POSTMessage属性"
        POST_PROPS["• String role<br/>• String content"]
    end
    
    subgraph "实体方法"
        BLOG_METHODS["• clone()<br/>• equals()<br/>• compareTo()<br/>• toString()"]
        MESSAGE_METHODS["• success()<br/>• error()<br/>• getStatus()<br/>• getData()"]
        CONFIG_METHODS["• validate()<br/>• getBlogStoragePath()<br/>• getImageStoragePath()"]
        POST_METHODS["• getRole()<br/>• getContent()<br/>• setRole()<br/>• setContent()"]
    end
    
    BLOG --> BLOG_PROPS
    BLOG --> BLOG_METHODS
    
    CONFIG --> CONFIG_PROPS
    CONFIG --> CONFIG_METHODS
    
    MESSAGE --> MESSAGE_PROPS
    MESSAGE --> MESSAGE_METHODS
    
    POST_MSG --> POST_PROPS
    POST_MSG --> POST_METHODS
    
    subgraph "数据验证与转换"
        VALIDATION[数据验证]
        SERIALIZATION[序列化/反序列化]
        COMPARISON[对象比较]
    end
    
    BLOG_METHODS --> VALIDATION
    BLOG_METHODS --> COMPARISON
    CONFIG_METHODS --> VALIDATION
    MESSAGE_METHODS --> SERIALIZATION
    POST_METHODS --> SERIALIZATION
    
    style BLOG fill:#ffebee
    style CONFIG fill:#ffebee
    style MESSAGE fill:#ffebee
    style POST_MSG fill:#ffebee
    style VALIDATION fill:#e8f5e8
    style SERIALIZATION fill:#e8f5e8
    style COMPARISON fill:#e8f5e8
```

### 5. 层间交互流程图

```mermaid
sequenceDiagram
    participant Client as 客户端
    participant Controller as 控制器层
    participant Service as 服务层
    participant Repository as 数据访问层
    participant Model as 实体层
    participant FileSystem as 文件系统
    
    Note over Client,FileSystem: 博客查询流程
    Client->>Controller: GET /api/blogs
    Controller->>Service: getAllBlogs()
    Service->>Repository: loadAllBlogs()
    Repository->>FileSystem: 读取.md文件
    FileSystem-->>Repository: 文件内容
    Repository->>Model: 创建Blog对象
    Model-->>Repository: Blog实例
    Repository-->>Service: List<Blog>
    Service->>Model: 创建Message对象
    Model-->>Service: Message实例
    Service-->>Controller: Message(博客列表)
    Controller-->>Client: JSON响应
    
    Note over Client,FileSystem: LLM对话流程
    Client->>Controller: POST /api/llm/chat
    Controller->>Service: 获取LLM实例
    Service->>Model: 使用Config配置
    Model-->>Service: 配置信息
    Service->>Repository: 创建LLM对象
    Repository-->>Service: LLM实例
    Service->>FileSystem: 调用第三方API
    FileSystem-->>Service: API响应
    Service-->>Controller: 流式响应
    Controller-->>Client: SSE流
```

## 架构特点总结

### 优势
1. **分层清晰**: 每层职责明确，依赖关系单向
2. **可扩展性**: 使用工厂模式，便于扩展新的LLM实现
3. **松耦合**: 通过接口和抽象类降低耦合度
4. **可测试性**: 各层独立，便于单元测试

### 改进建议
1. **引入真正的Repository层**: 将数据访问逻辑从Service中分离
2. **添加DTO层**: 在Controller和Service之间使用数据传输对象
3. **异常处理**: 统一的异常处理机制
4. **缓存机制**: 为频繁访问的数据添加缓存层
